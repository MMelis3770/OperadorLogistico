@using System.Text.Json
@using Newtonsoft.Json.Linq
@using System.Reflection
@using System.IO
@using BlazorTemplate.Models
@using BlazorTemplate.Interfaces
@using Microsoft.FluentUI.AspNetCore.Components
@inject IDialogService _dialogService
@inject IOrderService _orderService
@page "/TestTemplate"
@implements IDisposable

<PageTitle>Order Management</PageTitle>
<h1>Order Management</h1>

<FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
    <FluentButton Appearance="Appearance.Accent" OnClick="@LoadOrdersFromFiles">Cargar Comandas</FluentButton>
    <FluentSpacer />
    <FluentButton Appearance="Appearance.Accent" Style="margin-right: 40px" BackgroundColor="#28a745">Subir Comandas</FluentButton>
    @if (isLoading)
    {
        <FluentProgressRing />
        <span>Cargando comandas...</span>
    }
</FluentStack>

<!-- Contenedor principal -->
<div class="grid-and-pagination-container">
    <!-- Contenedor del grid -->
    <div class="fixed-height-grid-container">
        <FluentDataGrid Items="@orders" TGridItem="Order" Pagination="@pagination" Class="fixed-row-grid">

            <PropertyColumn Property="@(o => o.ID)" Sortable="true" />
            <PropertyColumn Property="@(o => o.Client)" Sortable="true" />
            <PropertyColumn Property="@(o => o.Date)" Format="yyyy-MM-dd" Sortable="true" />
            <PropertyColumn Property="@(o => o.Expiration)" Format="yyyy-MM-dd" Sortable="true" />
            <PropertyColumn Property="@(o => o.LineCount)" Title="Líneas" Sortable="true" />
            <TemplateColumn Title="Acción">
                <ChildContent>
                    <button @onclick="@(() => HandleRowClick(context))"
                            style="background: none; border: none; padding: 0; margin: 0; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Eye())" Color="Color.Accent" />
                    </button>
                </ChildContent>
            </TemplateColumn>
            <TemplateColumn Title="">
                <ChildContent>
                    <div @onclick="@(() => ToggleCheckedState(context.ID))" @onclick:stopPropagation="true" style="cursor: pointer;">
                        @if (IsOrderChecked(context.ID))
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size24.CheckboxChecked())" Color="Color.Accent" />
                        }
                        else
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size24.CheckboxUnchecked())" Color="Color.Accent" />
                        }
                    </div>
                </ChildContent>
            </TemplateColumn>
        </FluentDataGrid>
    </div>

    <!-- Contenedor para el contador y paginador -->
    <div class="paginator-container">
        <div class="left-section"></div>
        <div class="right-section">
            <FluentPaginator State="@pagination" />
        </div>
    </div>
</div>

@if (selectedOrder != null)
{
    <h2>Detalle de Comanda: @selectedOrder.ID - @selectedOrder.Client</h2>

    @if (selectedOrderItems != null && selectedOrderItems.Any())
    {
        <div class="detail-container">
            <FluentDataGrid Items="@selectedOrderItems" TGridItem="OrderLineItem" Class="detail-grid">
                <PropertyColumn Property="@(li => li.LineNumber)" Title="Línea" Sortable="true" />
                <PropertyColumn Property="@(li => li.ItemCode)" Title="Artículo" Sortable="true" />
                <PropertyColumn Property="@(li => li.Quantity)" Title="Cantidad" Sortable="true" />
            </FluentDataGrid>
        </div>

        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Style="margin-top: 16px;">
            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => ConfirmOrderToSAP(selectedOrder.ID))" Style="padding: 2px 8px; font-size: 13px;">
                Confirmar en SAP
            </FluentButton>
        </FluentStack>
    }
    else
    {
        <div class="alert alert-info" style="margin-top: 20px">
            No hay líneas disponibles para esta comanda.
        </div>
    }
}

@code {
    record Order(int ID, string Client, DateOnly Date, DateOnly Expiration, int LineCount);
    record OrderLineItem(int LineNumber, string ItemCode, int Quantity);

    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
    private IQueryable<Order> orders;
    private List<OrderData> processedOrders = new List<OrderData>();
    private Order selectedOrder;
    private IQueryable<OrderLineItem> selectedOrderItems;
    private System.Threading.Timer refreshTimer;
    private bool isLoading = false;

    // Dictionary to track checked state for each order
    private Dictionary<int, bool> checkedOrders = new Dictionary<int, bool>();

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    // Method to check if an order is checked
    private bool IsOrderChecked(int orderId)
    {
        return checkedOrders.ContainsKey(orderId) && checkedOrders[orderId];
    }

    // Method to toggle the checked state
    private void ToggleCheckedState(int orderId)
    {
        if (checkedOrders.ContainsKey(orderId))
        {
            checkedOrders[orderId] = !checkedOrders[orderId];
        }
        else
        {
            checkedOrders[orderId] = true;
        }
        StateHasChanged();
    }

    private async Task LoadOrdersFromFiles()
    {
        if (isLoading) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            // Usar OrderService para obtener órdenes
            processedOrders = await _orderService.GetOrdersAsync();

            // AÑADIR ESTA SECCIÓN DE DEPURACIÓN
            Console.WriteLine($"Se cargaron {processedOrders.Count} órdenes");
            foreach (var order in processedOrders)
            {
                Console.WriteLine($"Orden ID: {order.ID}, Cliente: {order.Client}, Líneas: {order.LineItems.Count}");
                // Imprimir algunas líneas para verificar que se cargaron correctamente
                foreach (var line in order.LineItems.Take(2))
                {
                    Console.WriteLine($"  - Línea {line.LineNumber}: {line.ItemCode}, Cantidad: {line.Quantity}");
                }
                if (order.LineItems.Count > 2)
                {
                    Console.WriteLine($"  - ... y {order.LineItems.Count - 2} líneas más");
                }
            }
            // FIN DE LA SECCIÓN DE DEPURACIÓN

            // Convertir a formato para la grid
            var orderList = processedOrders.Select(o => new Order(
                o.ID,
                o.Client,
                DateOnly.FromDateTime(o.OrderDate),
                DateOnly.FromDateTime(o.DueDate),
                o.LineItems.Count  // Mostrar número de líneas
            )).ToList();

            // Si hay menos órdenes que el tamaño de página, rellenar con filas vacías
            int itemsToAdd = Math.Max(0, pagination.ItemsPerPage - orderList.Count);
            for (int i = 0; i < itemsToAdd; i++)
            {
            // Usar IDs negativos para evitar conflictos de clave
                orderList.Add(new Order(-i - 1, $"Empty-{i + 1}", new DateOnly(), new DateOnly(), 0));
            }

            orders = orderList.AsQueryable();

            // Inicializar estado de checkboxes
            checkedOrders.Clear();
            foreach (var order in orderList.Where(o => o.ID > 0))
            {
                checkedOrders[order.ID] = false;
            }

            // Limpiar la selección actual si existe
            selectedOrder = null;
            selectedOrderItems = null;

            await _dialogService.ShowInfoAsync($"Se han cargado {processedOrders.Count} comandas.", "Información");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync($"Error al cargar comandas: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void HandleRowClick(Order order)
    {
        if (order == null || order.ID <= 0) return;  // Ignorar clics en filas vacías (ID ≤ 0)

        selectedOrder = order;
        Console.WriteLine($"Clic en orden: {selectedOrder.ID}"); // Log para depuración
        StateHasChanged(); // Forzar actualización para mostrar el encabezado de la sección de detalles

        // Busca en las órdenes procesadas
        var orderData = processedOrders.FirstOrDefault(o => o.ID == selectedOrder.ID);

        if (orderData != null && orderData.LineItems.Any())
        {
            // Convertir las líneas al formato para la grid
            var lineItems = orderData.LineItems
                .Select(li => new OrderLineItem(
                    li.LineNumber,
                    li.ItemCode,
                    li.Quantity
                ))
                .ToList();

            selectedOrderItems = lineItems.AsQueryable();
        }
        else
        {
            // Si no se encuentran líneas, mostrar una colección vacía
            selectedOrderItems = Array.Empty<OrderLineItem>().AsQueryable();
        }

        // Segunda llamada a StateHasChanged para actualizar la grid de líneas
        StateHasChanged();
    }

    private async Task ConfirmOrderToSAP(int orderId)
    {
        try
        {
            bool result = await _orderService.ConfirmOrderToSAP(orderId);

            if (result)
            {
                await _dialogService.ShowInfoAsync($"Orden {orderId} confirmada en SAP con éxito.", "Confirmación");
            }
            else
            {
                await _dialogService.ShowErrorAsync($"No se pudo confirmar la orden {orderId} en SAP.", "Error");
            }
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync($"Error al confirmar la orden en SAP: {ex.Message}", "Error");
        }
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}